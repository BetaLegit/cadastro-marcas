<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Marcas Avançado</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h1 class="mb-4">Cadastro de Marcas</h1>

  <form id="formMarca" class="mb-4" enctype="multipart/form-data">
    <input type="hidden" id="idMarca" />
    
    <div class="row g-3">
      <div class="col-md-4">
        <label for="numero_processo" class="form-label">Número do Processo</label>
        <input type="text" id="numero_processo" name="numero_processo" class="form-control" required />
      </div>
      <div class="col-md-4">
        <label for="nome" class="form-label">Nome da Marca</label>
        <input type="text" id="nome" name="nome" class="form-control" required />
      </div>
      <div class="col-md-4">
        <label for="titular" class="form-label">Titular</label>
        <input type="text" id="titular" name="titular" class="form-control" />
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-3">
        <label for="classe" class="form-label">Classe</label>
        <input type="text" id="classe" name="classe" class="form-control" />
      </div>
      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <input type="text" id="status" name="status" class="form-control" />
      </div>
      <div class="col-md-6">
        <label for="especificacoes" class="form-label">Especificações</label>
        <input type="text" id="especificacoes" name="especificacoes" class="form-control" />
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-6">
        <label for="observacoes" class="form-label">Observações</label>
        <input type="text" id="observacoes" name="observacoes" class="form-control" />
      </div>
      <div class="col-md-3">
        <label for="vendedor" class="form-label">Vendedor</label>
        <input type="text" id="vendedor" name="vendedor" class="form-control" />
      </div>
      <div class="col-md-3">
        <label for="comprador" class="form-label">Comprador</label>
        <input type="text" id="comprador" name="comprador" class="form-control" />
      </div>
    </div>

    <div class="mt-3">
      <label for="arquivo" class="form-label">Upload de Arquivo</label>
      <input type="file" id="arquivo" name="arquivo" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
  </form>

  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Número do Processo</th>
        <th>Nome da Marca</th>
      </tr>
    </thead>
    <tbody id="listaMarcas"></tbody>
  </table>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetalhesLabel">Detalhes da Marca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <dl class="row" id="detalhesConteudo"></dl>
      </div>
      <div class="modal-footer">
        <button type="button" id="btnExcluirMarca" class="btn btn-danger">Excluir</button>
        <button type="button" id="btnEditarModal" class="btn btn-primary">Editar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const api = 'https://cadastro-marcas.onrender.com';

function carregarMarcas() {
  fetch(`${api}/marcas`)
    .then(res => res.json())
    .then(data => {
      const lista = document.getElementById('listaMarcas');
      lista.innerHTML = '';
      data.forEach(marca => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.innerHTML = `
          <td>${marca.numero_processo}</td>
          <td>${marca.nome}</td>
        `;
        tr.addEventListener('click', () => abrirDetalhes(marca.numero_processo));
        lista.appendChild(tr);
      });
    });
}

function abrirDetalhes(numero_processo) {
  fetch(`${api}/marca/${numero_processo}`)
    .then(res => {
      if (!res.ok) throw new Error('Marca não encontrada');
      return res.json();
    })
    .then(data => {
      window.marcaDetalhada = data; // para uso no botão Editar

      const dl = document.getElementById('detalhesConteudo');
      dl.innerHTML = `
        <dt class="col-sm-3">Número do Processo:</dt><dd class="col-sm-9">${data.numero_processo}</dd>
        <dt class="col-sm-3">Nome da Marca:</dt><dd class="col-sm-9">${data.nome}</dd>
        <dt class="col-sm-3">Titular:</dt><dd class="col-sm-9">${data.titular || ''}</dd>
        <dt class="col-sm-3">Classe:</dt><dd class="col-sm-9">${data.classe || ''}</dd>
        <dt class="col-sm-3">Status:</dt><dd class="col-sm-9">${data.status || ''}</dd>
        <dt class="col-sm-3">Especificações:</dt><dd class="col-sm-9">${data.especificacoes || ''}</dd>
        <dt class="col-sm-3">Observações:</dt><dd class="col-sm-9">${data.observacoes || ''}</dd>
        <dt class="col-sm-3">Vendedor:</dt><dd class="col-sm-9">${data.vendedor || ''}</dd>
        <dt class="col-sm-3">Comprador:</dt><dd class="col-sm-9">${data.comprador || ''}</dd>
        <dt class="col-sm-3">Arquivo:</dt><dd class="col-sm-9">${data.arquivo ? `<a href="${api}/uploads/${data.arquivo}" target="_blank">Abrir Arquivo</a>` : '—'}</dd>
      `;

      // Abrir modal
      const modalEl = document.getElementById('modalDetalhes');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Botão Excluir
      const btnExcluir = document.getElementById('btnExcluirMarca');
      btnExcluir.onclick = () => {
        if (confirm('Deseja realmente excluir essa marca?')) {
          fetch(`${api}/marca/${data.numero_processo}`, { method: 'DELETE' })
            .then(res => {
              if (res.ok) {
                modal.hide();
                carregarMarcas();
              } else {
                alert('Erro ao excluir');
              }
            });
        }
      };
    })
    .catch(err => alert(err.message));
}

function limparForm() {
  document.getElementById('idMarca').value = '';
  document.getElementById('formMarca').reset();
}

document.getElementById('formMarca').addEventListener('submit', function(e) {
  e.preventDefault();

  const id = document.getElementById('idMarca').value;
  const formData = new FormData(this);

  let method = 'POST';
  let url = `${api}/marca`;
  if (id) {
    method = 'PUT';
    url = `${api}/marca/${id}`;
  }

  fetch(url, {
    method: method,
    body: formData,
  })
    .then(res => {
      if (!res.ok) throw new Error('Erro ao salvar');
      return res.json();
    })
    .then(() => {
      limparForm();
      carregarMarcas();
    })
    .catch(err => alert(err.message));
});

function editarMarca(numero_processo) {
  fetch(`${api}/marca/${numero_processo}`)
    .then(res => res.json())
    .then(marca => {
      // Preenche formulário para edição
      document.getElementById('idMarca').value = marca.numero_processo; // id agora é numero_processo
      document.getElementById('numero_processo').value = marca.numero_processo;
      document.getElementById('nome').value = marca.nome;
      document.getElementById('titular').value = marca.titular || '';
      document.getElementById('classe').value = marca.classe || '';
      document.getElementById('status').value = marca.status || '';
      document.getElementById('especificacoes').value = marca.especificacoes || '';
      document.getElementById('observacoes').value = marca.observacoes || '';
      document.getElementById('vendedor').value = marca.vendedor || '';
      document.getElementById('comprador').value = marca.comprador || '';
      // arquivo não pode ser preenchido por input file

      // Foca o input do nome para sinalizar edição
      document.getElementById('nome').focus();
    })
    .catch(err => alert('Erro ao carregar marca para edição'));
}

// Botão editar dentro do modal (substitui o fechar)
document.getElementById('btnEditarModal').addEventListener('click', () => {
  if (!window.marcaDetalhada) return;

  editarMarca(window.marcaDetalhada.numero_processo);

  // Fecha modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
  if (modal) modal.hide();
});

// Carrega lista inicial
carregarMarcas();
</script>
</body>
</html>
